<!DOCTYPE html>
<html lang='en'><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/>
<title>3-Week Sales CRM</title>
<style>
/* Updated color palette inspired by The Travel Agency branding */
:root{
  --bone:#f5f1e5; /* light cream background */
  --coffee:#3c2a21; /* dark brown text */
  --honey:#e6582c; /* warm coral accent */
  --mint:#00cfcf;  /* mint accent used on buttons and highlights */
  --glass:rgba(255,255,255,0.10); /* subtle card overlay */
}
html,body{
  margin:0;
  color:var(--coffee);
  /* Soft, uplifting background inspired by the Travel Agency’s airy vibe */
  background:
    radial-gradient(1200px 600px at 20% 0%, rgba(0,207,204,0.10), transparent),
    radial-gradient(1200px 800px at 80% 20%, rgba(230,88,44,0.08), transparent),
    linear-gradient(180deg,#f5f1e5,#fefdf9);
  font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
.container{max-width:1200px;margin:24px auto 80px;padding:0 16px}
/* Header styling: simple cream backdrop with no sticky positioning */
.header{
  position: static;
  background: linear-gradient(180deg,rgba(245,241,229,0.95),rgba(245,241,229,0.75));
  color: var(--coffee);
  backdrop-filter: none;
  z-index: 10;
  padding: 16px 0 8px;
}
h1{margin:0 0 8px 0;font-weight:800;letter-spacing:.5px;text-shadow:0 2px 12px rgba(230,88,44,.2)}
  /* KPIs grid: auto-fit ensures cards wrap nicely when more items are added */
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:8px 0 20px}
.card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.03));border:1px solid rgba(60,42,33,.15);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);transition:transform .15s,box-shadow .15s,border-color .15s}
.card:hover{transform:translateY(-2px);box-shadow:0 16px 42px rgba(60,42,33,.12);border-color:rgba(230,88,44,.45)}
.metric{font-size:28px;font-weight:800;margin-top:4px;letter-spacing:.3px}
.muted{color:#7a6653;opacity:.85;font-size:12px}
.section-title{margin:28px 0 8px;font-size:18px;font-weight:800;letter-spacing:.4px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){
  .kpis{grid-template-columns:1fr;}
  .two-col{grid-template-columns:1fr;}
  /* Remove table header offset on smaller screens to prevent overlay issues */
}
@media(max-width:600px){
  .kpis{grid-template-columns:1fr;}
  .two-col{grid-template-columns:1fr;}
  h1{font-size:24px;}
  .metric{font-size:24px;}
  .section-title{font-size:16px;}
  th,td{padding:8px 8px;font-size:11px;}
  .container{padding:0 8px;margin:24px auto 40px;}
  table{display:block;overflow-x:auto;}
}

table{width:100%;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,.02);border:1px solid rgba(60,42,33,.15);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.25);display:block;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth}
/* Disable sticky positioning on table headers to avoid overlaying the content when scrolling */
thead th{
  z-index:5;
  /* Use coral gradient for table header backgrounds */
  background:linear-gradient(180deg,rgba(230,88,44,.15),rgba(230,88,44,.05));
  backdrop-filter:blur(6px);
}
th,td{text-align:left;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
tbody tr{transition:background .12s, transform .12s}tbody tr:hover{background:rgba(230,88,44,.08);transform:scale(1.002)}
.right{text-align:right}.chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(60,42,33,.3);font-weight:700}.up{color:var(--mint)}.down{color:var(--honey)}
button.btn{background:var(--mint);color:var(--coffee);padding:4px 10px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:background .15s}
button.btn:hover{background:rgba(0,207,207,0.8)}
button.btn:disabled{opacity:.5;cursor:not-allowed}

/* Filter bar for category toggle */
.filter-bar{
  margin:16px 0;
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.filter-label{
  font-weight:600;
  color:var(--coffee);
}
.filter-select{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(60,42,33,.25);
  background:rgba(255,255,255,0.8);
  color:var(--coffee);
  font-weight:600;
}
.filter-select:focus{
  outline:none;
  box-shadow:0 0 0 2px rgba(230,88,44,.3);
}

/* Summary section styles */
.summary-section{margin-top:28px;}
.summary-item{margin-bottom:12px;}
.summary-toggle{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:12px 16px;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.03));border:1px solid rgba(60,42,33,.15);border-radius:16px;font-weight:700;}
.summary-toggle .arrow{transition:transform .3s ease;}
.summary-content{overflow:hidden;max-height:0;transition:max-height .4s ease;padding:0 16px;background:rgba(255,255,255,.02);border:1px solid rgba(60,42,33,.1);border-top:none;border-radius:0 0 16px 16px;}
.summary-content.expanded{max-height:800px;padding:16px;}
</style></head>
<body>
<div class='header'><div class='container'><h1>3-Week Sales CRM</h1></div></div>
<div class='container'>
  <div class='kpis'>
    <div class='card'><div class='muted'>Total Revenue</div><div id='kpi-rev' class='metric'>—</div></div>
    <div class='card'><div class='muted'>Total Units</div><div id='kpi-units' class='metric'>—</div></div>
    <div class='card'><div class='muted'>Top 20 SKU Share</div><div id='kpi-share' class='metric'>—</div></div>
    <!-- Previous week (last 7 days) summary cards -->
    <div class='card'><div class='muted'>Prev 7d Revenue</div><div id='kpi-prev-rev' class='metric'>—</div></div>
    <div class='card'><div class='muted'>Prev 7d Units</div><div id='kpi-prev-units' class='metric'>—</div></div>
  </div>

  <!-- Category filter toggle to view performance by cannabis category -->
  <div class='filter-bar'>
    <label for="category-filter" class="filter-label">Category:</label>
    <select id="category-filter" class="filter-select"></select>
  </div>

  <div class='section-title'>Movers — Top 10 Growers & Top 10 Shrinkers</div>
  <div class='two-col'>
    <div class='card'><div class='chip up'>▲ Top Growers</div><table id='movers-growers'></table></div>
    <div class='card'><div class='chip down'>▼ Top Shrinkers</div><table id='movers-shrinkers'></table></div>
  </div>

  <div class='section-title'>Top & Bottom Sellers (Revenue)</div>
  <div class='card'><table id='top-sellers'></table></div>
  <div class='card' style='margin-top:12px'><table id='bottom-sellers'></table></div>

  <div class='section-title'>Sell-Through</div>
  <div class='card'><table id='sell-top'></table></div>
  <div class='card' style='margin-top:12px'><table id='sell-bottom'></table></div>

  <div class='section-title'>Most & Least Sold (Units)</div>
  <div class='card'><table id='most-units'></table></div>
  <div class='card' style='margin-top:12px'><table id='least-units'></table></div>

  <div class='section-title'>Loyalty — Frequent Flyers</div>
  <div class='card'>
    <div class='muted'>Counts show the current 3-week window. Threshold: <span id="ff-threshold">10</span>.</div>
    <table id='loyalty-table'></table>
    <div class='muted' style='margin-top:8px'>Click <b>Redeem</b> when a budtender crosses a multiple of the threshold; this will notify the manager by email.</div>
  </div>

  <!-- Summary & Insights Section -->
  <div class='section-title'>Summary & Insights</div>
  <div class='summary-section'>
    <div class='summary-item'>
      <div class='summary-toggle' data-target='summary-data'>
        <h3 style='margin:0;font-size:16px;font-weight:700;'>Data Summary</h3>
        <span class='arrow'>▼</span>
      </div>
      <div id='summary-data' class='summary-content'></div>
    </div>
    <div class='summary-item'>
      <div class='summary-toggle' data-target='summary-solutions'>
        <h3 style='margin:0;font-size:16px;font-weight:700;'>Solutions &amp; Challenges</h3>
        <span class='arrow'>▼</span>
      </div>
      <div id='summary-solutions' class='summary-content'></div>
    </div>
  </div>
</div>

<script>
const fmtCurrency=n=>(n??0).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
const fmtInt=n=>(n??0).toLocaleString(undefined,{maximumFractionDigits:0});
const fmtPct=n=>((n??0)*100).toLocaleString(undefined,{maximumFractionDigits:1})+'%';
function table(el,rows,cols){
  const thead=document.createElement('thead');
  const trh=document.createElement('tr');
  cols.forEach(c=>{
    const th=document.createElement('th');
    th.textContent=c.label;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  const tbody=document.createElement('tbody');
  if(Array.isArray(rows) && rows.length>0){
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      cols.forEach(c=>{
        const td=document.createElement('td');
        let v=r[c.key];
        if(c.format==='currency') v=fmtCurrency(v);
        if(c.format==='int') v=fmtInt(v);
        if(c.format==='pct') v=fmtPct(v);
        td.textContent=(v===undefined||v===null||v==='') ? '—' : v;
        if(c.align==='right') td.classList.add('right');
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  } else {
    // Show a placeholder row when no data is available
    const tr=document.createElement('tr');
    const td=document.createElement('td');
    td.textContent='No data';
    td.colSpan=cols.length;
    td.style.textAlign='center';
    tr.appendChild(td);
    tbody.appendChild(tr);
  }
  el.innerHTML='';
  el.appendChild(thead);
  el.appendChild(tbody);
}
function pickTopN(arr,key,n,asc=false){const copy=[...(arr||[])].filter(x=>x&&x[key]!==null&&x[key]!==undefined);copy.sort((a,b)=>asc?(a[key]-b[key]):(b[key]-a[key]));return copy.slice(0,n)}
async function load(){
  let DATA=null;
  try{const res=await fetch('sales_crm_sku_data.json');if(!res.ok)throw new Error();DATA=await res.json()}catch(e){DATA={kpis:{},sku_movers_up:[],sku_movers_down:[],sku_top_revenue:[],sku_bottom_revenue:[],sku_sellthrough_top:[],sku_sellthrough_bottom:[],sku_most_units:[],sku_least_units:[]}};
  window.DATA=DATA;

  document.getElementById('kpi-rev').textContent=fmtCurrency(DATA.kpis?.total_revenue);
  document.getElementById('kpi-units').textContent=fmtInt(DATA.kpis?.total_units);
  document.getElementById('kpi-share').textContent=fmtPct(DATA.kpis?.top20_sku_share_pct);

  // Populate previous week (last 7 days) summary if available
  // Prefer the `prev_week` object when provided. Some data sets may embed
  // these values inside the `kpis` object using the keys `prev_week_revenue`
  // and `prev_week_units`. Fall back to those fields if `prev_week` is
  // undefined.
  if (DATA.prev_week) {
    document.getElementById('kpi-prev-rev').textContent = fmtCurrency(DATA.prev_week.total_revenue);
    document.getElementById('kpi-prev-units').textContent = fmtInt(DATA.prev_week.total_units);
  } else if (DATA.kpis) {
    const rev = DATA.kpis.prev_week_revenue;
    const units = DATA.kpis.prev_week_units;
    document.getElementById('kpi-prev-rev').textContent = fmtCurrency(rev);
    document.getElementById('kpi-prev-units').textContent = fmtInt(units);
  }

  const moverCols=[
    {key:'product',label:'Product'},
    {key:'vendor',label:'Vendor'},
    {key:'W1',label:'W1',format:'currency',align:'right'},
    {key:'W2',label:'W2',format:'currency',align:'right'},
    {key:'W3',label:'W3',format:'currency',align:'right'},
    {key:'W3_vs_W1',label:'W3 vs W1',format:'pct',align:'right'}
  ];
  // Columns definitions for each table
  const revCols=[
    {key:'product',label:'Product'},
    {key:'vendor',label:'Vendor'},
    {key:'category',label:'Category'},
    {key:'units',label:'Units',format:'int',align:'right'},
    {key:'revenue',label:'Revenue',format:'currency',align:'right'},
    {key:'pct_total',label:'% of Total',format:'pct',align:'right'}
  ];
  const stCols=[
    {key:'product',label:'Product'},
    {key:'vendor',label:'Vendor'},
    {key:'units_sold',label:'Units',format:'int',align:'right'},
    {key:'units_received',label:'Received',format:'int',align:'right'},
    {key:'sell_through',label:'Sell-Through',format:'pct',align:'right'}
  ];
  const unitCols=[
    {key:'product',label:'Product'},
    {key:'vendor',label:'Vendor'},
    {key:'category',label:'Category'},
    {key:'units',label:'Units',format:'int',align:'right'},
    {key:'revenue',label:'Revenue',format:'currency',align:'right'}
  ];
  // Populate category filter options
  const selectEl = document.getElementById('category-filter');
  if(selectEl){
    // gather categories from all relevant arrays
    const allItems = [];
    ['sku_top_revenue','sku_bottom_revenue','sku_most_units','sku_least_units','sku_sellthrough_top','sku_sellthrough_bottom','sku_movers_up','sku_movers_down'].forEach(key=>{
      const arr = DATA[key] || [];
      arr.forEach(item => { if(item && item.category) allItems.push(item.category); });
    });
    const cats = Array.from(new Set(allItems)).sort();
    cats.unshift('All');
    // Clear existing options
    selectEl.innerHTML='';
    cats.forEach(cat => { const opt=document.createElement('option'); opt.value=cat; opt.textContent=cat; selectEl.appendChild(opt); });
    selectEl.addEventListener('change', updateTables);
  }

  // Function to filter arrays by selected category and update all tables
  function updateTables(){
    const selected = selectEl ? selectEl.value : 'All';
    const filterCategory = arr => {
      if(!arr) return [];
      if(!selected || selected==='All') return [...arr];
      return arr.filter(item => item && item.category === selected);
    };
    // Movers: always show the top 10 growers and shrinkers across the entire dataset
    // Regardless of the selected category, the movers section highlights overall performance trends.
    table(
      document.getElementById('movers-growers'),
      pickTopN(DATA.sku_movers_up,'W3_vs_W1',10,false),
      moverCols
    );
    table(
      document.getElementById('movers-shrinkers'),
      pickTopN(DATA.sku_movers_down,'W3_vs_W1',10,true),
      moverCols
    );
    // Top & bottom sellers
    table(
      document.getElementById('top-sellers'),
      filterCategory(DATA.sku_top_revenue).slice(0,25),
      revCols
    );
    table(
      document.getElementById('bottom-sellers'),
      filterCategory(DATA.sku_bottom_revenue).slice(0,25),
      revCols
    );
    // Sell-through
    table(
      document.getElementById('sell-top'),
      filterCategory(DATA.sku_sellthrough_top).slice(0,25),
      stCols
    );
    table(
      document.getElementById('sell-bottom'),
      filterCategory(DATA.sku_sellthrough_bottom).slice(0,25),
      stCols
    );
    // Most & least sold units
    table(
      document.getElementById('most-units'),
      filterCategory(DATA.sku_most_units).slice(0,25),
      unitCols
    );
    table(
      document.getElementById('least-units'),
      filterCategory(DATA.sku_least_units).slice(0,25),
      unitCols
    );
  }
  // Initial table rendering
  updateTables();

  // Load loyalty signups and then summary
  await loadLoyalty();
  loadSummary();
}
async function loadLoyalty(){
  let cfg={threshold:10,email_to:"",email_subject:"Redeem",email_from:""};
  try{const r=await fetch('loyalty_config.json');if(r.ok)cfg=await r.json()}catch(e){}
  const thr = cfg.threshold??10;
  document.getElementById('ff-threshold').textContent=thr;
  let rows=[];try{const r=await fetch('loyalty_signups.json');if(r.ok)rows=await r.json()}catch(e){}
  // expose loyalty signups for summary calculations
  window.LOYALTY_ROWS = rows;
  const today=new Date();const fallbackStart=new Date(today.getTime()-21*86400000);let start=fallbackStart,end=today;
  if(window.DATA&&window.DATA.data_notes){if(window.DATA.data_notes.period_start)start=new Date(window.DATA.data_notes.period_start+"T00:00:00");if(window.DATA.data_notes.period_end)end=new Date(window.DATA.data_notes.period_end+"T23:59:59")}
  const inWindow=rows.filter(r=>{const d=new Date((r.date||'')+'T00:00:00');return !isNaN(d)&&d>=start&&d<=end});
  const map=new Map();inWindow.forEach(r=>{const key=r.budtender||'Unknown';if(!map.get(key))map.set(key,{budtender:key,count:0,store:r.store||''});map.get(key).count+=1});
  const data=Array.from(map.values()).map(x=>{const nextMilestone=Math.ceil((x.count||0)/thr)*thr||thr;const progress=((x.count||0)%thr)/thr;const canRedeem=(x.count>0)&&(x.count%thr===0);return{budtender:x.budtender,store:x.store,count:x.count,next_at:nextMilestone,progress_pct:progress,canRedeem}}).sort((a,b)=>b.count-a.count);
  const cols=[{key:'budtender',label:'Budtender'},{key:'store',label:'Store'},{key:'count',label:'Frequent Flyers',align:'right'},{key:'next_at',label:'Next at',align:'right'},{key:'progress_pct',label:'Progress',align:'right',format:'pct'},{key:'__action',label:'Action'}];
  const tableEl=document.getElementById('loyalty-table');const thead=document.createElement('thead');const trh=document.createElement('tr');cols.forEach(c=>{const th=document.createElement('th');th.textContent=c.label;trh.appendChild(th)});thead.appendChild(trh);const tbody=document.createElement('tbody');data.forEach(row=>{const tr=document.createElement('tr');cols.forEach(c=>{const td=document.createElement('td');if(c.key==='__action'){const btn=document.createElement('button');btn.textContent=row.canRedeem?'Redeem':'—';btn.disabled=!row.canRedeem;btn.className='btn';btn.onclick=async()=>{try{const resp=await fetch('/.netlify/functions/redeem-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({budtender:row.budtender,store:row.store,count:row.count,threshold:thr,to:cfg.email_to,subject:cfg.email_subject})});if(!resp.ok)throw new Error('function failed');alert('Redeem request sent.')}catch(e){const subject=encodeURIComponent((cfg.email_subject||'Redeem')+' - '+row.budtender);const body=encodeURIComponent(`Budtender: ${row.budtender}\nStore: ${row.store}\nFrequent Flyers: ${row.count}\nThreshold: ${thr}\n`);window.location.href=`mailto:${cfg.email_to}?subject=${subject}&body=${body}`;}};td.appendChild(btn)}else{let v=row[c.key];if(c.format==='pct')v=((v??0)*100).toFixed(0)+'%';td.textContent=(v===undefined||v===null||v==='')?'—':v;if(c.align==='right')td.classList.add('right')}tr.appendChild(td)});tbody.appendChild(tr)});tableEl.innerHTML='';tableEl.appendChild(thead);tableEl.appendChild(tbody)}
document.addEventListener('DOMContentLoaded',load);

// Compose summary and populate the Summary & Insights section
function loadSummary(){
  const DATA = window.DATA || {};
  // Build summary for categories
  const cats = (DATA.category_mix || []).slice();
  // Sort by percentage descending for top and ascending for bottom
  cats.sort((a,b)=>b.percentage - a.percentage);
  const topCats = cats.slice(0,3).map(c => `${c.category} (${fmtPct(c.percentage)})`);
  const bottomCats = cats.slice(-3).map(c => `${c.category} (${fmtPct(c.percentage)})`);
  // Frequent Flyer summary
  let dataHtml = '';
  dataHtml += `<p><b>Top Categories:</b> ${topCats.join(', ') || '—'}</p>`;
  dataHtml += `<p><b>Bottom Categories:</b> ${bottomCats.join(', ') || '—'}</p>`;
  // KPIs summary
  dataHtml += `<p><b>Total Revenue:</b> ${fmtCurrency(DATA.kpis?.total_revenue)} • <b>Total Units:</b> ${fmtInt(DATA.kpis?.total_units)}</p>`;
  // Frequent Flyers summary by budtender
  if(Array.isArray(window.LOYALTY_ROWS) && window.LOYALTY_ROWS.length){
    const m = new Map();
    window.LOYALTY_ROWS.forEach(r => {
      const key = r.budtender || 'Unknown';
      m.set(key, (m.get(key) || 0) + 1);
    });
    const sorted = Array.from(m.entries()).sort((a,b) => b[1] - a[1]);
    dataHtml += '<p><b>Top Budtenders by Frequent Flyers:</b></p><ul style="margin:4px 0 12px 16px;">';
    sorted.slice(0,5).forEach(([name,count]) => {
      dataHtml += `<li>${name} – ${count} signups</li>`;
    });
    dataHtml += '</ul>';
  }
  document.getElementById('summary-data').innerHTML = dataHtml;
  // Strengths and challenges derived from the sales data
  const solutions = [
    'Strong revenue concentration in Flower and Pre‑Roll categories (over half of total sales).',
    'Top sellers like Ruby Classics Pre Roll Multi Pack White Widow 7pk and Find Flower Slingria 28G drive significant revenue and unit volume.',
    'High sell‑through ratios on select accessories and pre‑rolls (e.g., ONGROK Aluminum Multi‑Hitter) indicate efficient inventory management.',
    'Healthy Frequent Flyer participation, with leading budtenders securing multiple sign‑ups during the three‑week period.'
  ];
  const challenges = [
    'Several accessories and infused pre‑rolls exhibit steep declines (>80% drop in revenue) despite being stocked, suggesting waning customer interest.',
    'Underperforming segments like CBD, Topical, and Tincture categories show minimal revenue share.',
    'Low sell‑through items such as Her Highness Pleasure Oil and HB Flower Hella Jelly point to over‑stocking or poor demand.',
    'Maintaining inventory for high‑growth movers is critical to avoid stock‑outs and missed revenue opportunities.'
  ];
  let solHtml = '<p><b>Strengths:</b></p><ul style="margin:4px 0 12px 16px;">';
  solutions.forEach(item => { solHtml += `<li>${item}</li>`; });
  solHtml += '</ul><p><b>Challenges:</b></p><ul style="margin:4px 0 12px 16px;">';
  challenges.forEach(item => { solHtml += `<li>${item}</li>`; });
  solHtml += '</ul>';
  document.getElementById('summary-solutions').innerHTML = solHtml;
  // Toggle behavior
  document.querySelectorAll('.summary-toggle').forEach(tog => {
    const targetId = tog.getAttribute('data-target');
    const target = document.getElementById(targetId);
    const arrow = tog.querySelector('.arrow');
    // ensure collapsed state initially
    target.classList.remove('expanded');
    arrow.style.transform = 'rotate(0deg)';
    tog.onclick = () => {
      const expanded = target.classList.toggle('expanded');
      arrow.style.transform = expanded ? 'rotate(180deg)' : 'rotate(0deg)';
    };
  });
}
</script>
</body></html>